---
layout: post
title: JPA 활용[2] 성능개선 - API개발고급
subtitle: DTO 변환
gh-repo: daattali/beautiful-jekyll
thumbnail-img: /assets/img/jpa.png
cover-img: /assets/img/natural_design.jpg
tags: [jpa, API고급, 지연로딩, DTO]
comments: true
categories: jpa
---

___
## 목표

#### 1. 조회용 샘플 데이터 입력 [준비]
#### 2. 지연 로딩과 조회 성능 최적화 할 수 있다.
#### 3. 컬렉션 조회 최적화 하는 방법을 알 수 있다.
#### 4. 페이징과 한계 돌파를 할 수 있다.
#### 5. OSIV와 성능 최적화에 대해 알아보자.
___

<br/>

준비된 db 값들로 지연로딩에서의 조회 성능 최적화 단계별 진행 한다.

| 단계 | . | . |
|:---:|:---:|:---:|
| `엔티티 노출` | . | . |
| `DTO 변환` | . | . |
| `패치 조인 최적화` | . | . |
| `DTO 바로 조회` | . | . |

___

__DTO 변환__

~~~java

/**
 * XtoOne 관계 (ManyToOne, OneToOne)
 * Order 조회
 * Order -> Member 연관   ManyToOne
 * Order -> Delivery 연관 OneToOne
 */
@RestController
@RequiredArgsConstructor
public class OrderSimpleApiController {
    private final OrderRepositoy orderRepositoy;

    @GetMapping("/api/v2/simple-orders")
    public List<SimpleOrderDto> ordersV2() {

        List<Orders> orders = orderRepositoy.findAllByString(new OrderSearch());
        List<SimpleOrderDto> result = orders.stream()
                .map(SimpleOrderDto::new)
                .collect(toList());
        return result;
    }

    @Data
    static class SimpleOrderDto{
        private Long orderId;
        private String name;
        private LocalDateTime orderDate;
        private OrderStatus orderStatus;
        private Address address;

        public SimpleOrderDto(Orders order) {
            orderId = order.getId();
            name = order.getMember().getName();     //Lazy 초기화 시점.
            orderDate = order.getOrderDate();
            orderStatus = order.getStatus();
            address = order.getDelivery().getAddress();     //Lazy 초기화 시점.
        }
    }
}
~~~

> - DTO 변환이 일반적으로 사용된다.
> - 하지만 아직 N + 1 문제는 해결되지 않았다.